<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>{{TITLE}}</title>
<style>
  :root{
    --bg:#fafafa; --card:#fff; --text:#0f172a; --muted:#475569; --ring:#e5e7eb; --chip:#eef2ff; --pill:#f1f5f9;
    --shadow:0 1px 2px rgba(0,0,0,.06),0 4px 12px rgba(0,0,0,.06);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#9aa4b2; --ring:#1f2937; --chip:#0f172a; --pill:#111827;
    --shadow:0 1px 2px rgba(0,0,0,.5),0 6px 18px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:500 16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Calibri;
  }
  .container{max-width:980px;margin:96px auto 40px;padding:0 16px}
  /* Sticky header */
  .topbar{
    position:fixed; inset:0 0 auto 0; background:var(--bg); border-bottom:1px solid var(--ring);
    display:flex; gap:12px; align-items:center; padding:14px 16px; z-index:50;
    backdrop-filter:saturate(160%) blur(8px);
  }
  .brand{font-weight:800; letter-spacing:.2px; font-size:20px}
  .spacer{flex:1}
  .input, .select{
    background:var(--card); color:var(--text); border:1px solid var(--ring); border-radius:10px;
    padding:10px 12px; outline:none; min-width:220px; box-shadow:var(--shadow,none);
  }
  .toggle{border:1px solid var(--ring); background:var(--card); color:var(--text);
    border-radius:999px; padding:8px 12px; cursor:pointer}
  .muted{color:var(--muted); font-size:13px}
  .updated{margin-left:6px}
  /* Keyword pills */
  .keywords{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 20px}
  .pill{
    display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
    border:1px solid var(--ring); background:var(--pill); font-size:12px; cursor:pointer; user-select:none;
  }
  .pill.active{outline:2px solid #6366f1}
  /* Cards */
  .group-date{margin:22px 0 12px; font-weight:700}
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:14px 16px; margin:10px 0;
    box-shadow:var(--shadow); transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .card:hover{transform:translateY(-1px)}
  .meta{display:flex; align-items:center; gap:10px; font-size:12px; color:var(--muted); margin-bottom:6px}
  .meta img{width:14px;height:14px;border-radius:3px}
  .title{font-size:18px; font-weight:800; line-height:1.35; margin:0}
  .title a{color:inherit; text-decoration:none}
  .title a:hover{text-decoration:underline}
  /* Source dropdown */
  .select{min-width:180px}
  /* Small helpers */
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
</style>
</head>
<body>
  <!-- Sticky header -->
  <div class="topbar">
    <div class="brand">{{TITLE}}</div>
    <div class="muted updated">Updated: {{UPDATED}} â€¢ Items: {{COUNT}}</div>
    <div class="spacer"></div>
    <input id="q" class="input" placeholder="Search title/summaryâ€¦ (e.g., CVE-2025, Fortinet, RCE)">
    <select id="source" class="select">
      <option value="">All sources</option>
    </select>
    <button id="theme" class="toggle" title="Toggle theme">ðŸŒ“ Theme</button>
  </div>

  <div class="container">
    <div class="muted">Keywords:</div>
    <div id="kw" class="keywords"> {{KEYWORDS}} </div>

    <div id="list">{{ITEMS}}</div>
  </div>

<script>
/* ---------- Theme ---------- */
const root = document.documentElement;
const savedTheme = localStorage.getItem("theme");
if (savedTheme) root.setAttribute("data-theme", savedTheme);
document.getElementById("theme").onclick = () => {
  const next = root.getAttribute("data-theme")==="dark" ? "light" : "dark";
  root.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
};

/* ---------- Enhance cards (favicon, grouping, filters) ---------- */
const list = document.getElementById('list');
const cards = [...list.querySelectorAll('.card')];

// Add favicons + collect sources
const sources = new Set();
cards.forEach(card => {
  const link = card.querySelector('a')?.href || '';
  try {
    const host = new URL(link).hostname;
    const icon = `https://www.google.com/s2/favicons?domain=${host}`;
    const img = document.createElement('img');
    img.loading = "lazy"; img.decoding = "async"; img.src = icon;
    card.querySelector('.meta').prepend(img);
  } catch(e){}
  const s = card.dataset.source || '';
  if (s) sources.add(s);
});

// Populate source dropdown
const sourceSel = document.getElementById('source');
[...sources].sort().forEach(s=>{
  const opt = document.createElement('option');
  opt.value = s; opt.textContent = s;
  sourceSel.appendChild(opt);
});

// Insert day separators (Today / Yesterday / Date)
function dayLabel(d) {
  const today = new Date(); today.setHours(0,0,0,0);
  const that = new Date(d); that.setHours(0,0,0,0);
  const diff = (today - that)/(1000*60*60*24);
  if (diff === 0) return "Today";
  if (diff === 1) return "Yesterday";
  return that.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
}
(function groupByDay(){
  let last = '';
  cards.forEach(card=>{
    const when = new Date(card.dataset.date || Date.now());
    const label = dayLabel(when);
    if (label !== last) {
      const h = document.createElement('div');
      h.className = 'group-date'; h.textContent = label;
      list.insertBefore(h, card);
      last = label;
    }
  });
})();

/* ---------- Filters: search + source + pill click ---------- */
const q = document.getElementById('q');
const kwContainer = document.getElementById('kw');

function applyFilters(){
  const query = q.value.trim().toLowerCase();
  const src = sourceSel.value;
  const activePills = [...kwContainer.querySelectorAll('.pill.active')].map(p=>p.dataset.k);
  cards.forEach(card=>{
    const text = (card.textContent || '').toLowerCase();
    const matchQ = !query || text.includes(query);
    const matchS = !src || (card.dataset.source === src);
    const matchK = activePills.length===0 || activePills.some(k=>text.includes(k));
    card.style.display = (matchQ && matchS && matchK) ? '' : 'none';
  });
  // hide empty day headers
  [...document.querySelectorAll('.group-date')].forEach(h=>{
    let next = h.nextElementSibling, any=false;
    while(next && !next.classList.contains('group-date')){
      if (next.style.display !== 'none'){ any=true; break; }
      next = next.nextElementSibling;
    }
    h.style.display = any ? '' : 'none';
  });
}
q.addEventListener('input', applyFilters);
sourceSel.addEventListener('change', applyFilters);

// Make keyword pills interactive
kwContainer.querySelectorAll('.pill').forEach(p=>{
  const k = (p.textContent||'').trim().toLowerCase();
  p.dataset.k = k;
  p.addEventListener('click', ()=>{
    p.classList.toggle('active');
    applyFilters();
  });
});

// Initial run
applyFilters();
</script>

<!-- Server renders each item like:
<div class="card" data-source="BleepingComputer" data-date="2025-08-30T21:52:51Z">
  <div class="meta">BleepingComputer â€” 30/08/2025, 21:52:51</div>
  <h2 class="title"><a href="https://...">Title</a></h2>
</div>
-->
</body>
</html>
